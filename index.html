<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–î–æ–ø –ò–Ω—Ñ–∞ ‚Äî –°–ø–∏—á–∏ –∏ –ê—É–¥–∏–æ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --accent:#6c5ce7; }
    *{box-sizing:border-box}
    body{font-family:system-ui, Arial; margin:16px; background:#0f1226; color:#e9e9f5}
    h2{margin:0 0 12px}
    .tabs{display:flex; gap:8px; margin-bottom:12px}
    .tab{padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06); cursor:pointer; user-select:none}
    .tab.active{background:var(--accent); border-color:var(--accent); color:#fff}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); border-radius:14px; padding:12px}
    .title{font-weight:600; margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .meta{font-size:12px; color:#b8bcff; margin-bottom:8px}
    .btn{display:inline-block; padding:9px 12px; border-radius:10px; border:0; background:var(--accent); color:#fff; text-decoration:none}
    .note{font-size:13px; color:#bfc3ff}
    .muted{color:#9aa0ff;font-size:13px}
    audio{width:100%; margin-top:6px}
    .empty{opacity:.8}
  </style>
</head>
<body>
  <h2>üß© –î–æ–ø –ò–Ω—Ñ–∞</h2>
  <div class="tabs">
    <div id="tab-speech" class="tab active">–ß–∏—Ç–∞—Ç—å —Å–ø–∏—á–∏</div>
    <div id="tab-audio"  class="tab">–°–ª—É—à–∞—Ç—å —Ö–æ–ª–æ–¥–∫—É</div>
  </div>

  <div id="wrap-speech" class="grid"></div>
  <div id="wrap-audio"  class="grid" style="display:none"></div>

<script>
  const tg = window.Telegram.WebApp; tg.expand();

  // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ —Ç–≤–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
  const OWNER  = "igorogolenko815-ui";
  const REPO   = "blog-web";
  const BRANCH = "main";

  // jsDelivr DATA API ‚Äî —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤—Å–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
  const DATA_API = `https://data.jsdelivr.com/v1/package/gh/${OWNER}/${REPO}@${BRANCH}`;
  // CDN –¥–ª—è –æ—Ç–¥–∞—á–∏ —Å–∞–º–∏—Ö —Ñ–∞–π–ª–æ–≤
  const CDN_BASE = `https://cdn.jsdelivr.net/gh/${OWNER}/${REPO}@${BRANCH}`;

  const DOC_EXT = [".pdf",".doc",".docx",".txt"];
  const AUD_EXT = [".mp3",".m4a",".wav",".ogg"];

  const fmtSize = b => {
    if (b == null) return "";
    const u = ["–ë","–ö–ë","–ú–ë","–ì–ë"]; let i=0;
    while (b>=1024 && i<u.length-1){ b/=1024; i++; }
    return `${b.toFixed(i?1:0)} ${u[i]}`;
  };
  const nice = s => (s||"").replace(/^.*\//,"").replace(/[_\-]+/g," ").replace(/\s+/g," ").trim();
  const endsWithAny = (name, exts) => exts.some(e => name.toLowerCase().endsWith(e));

  function extType(name){
    const n = name.toLowerCase();
    if(n.endsWith(".mp3")) return "audio/mpeg";
    if(n.endsWith(".m4a")) return "audio/mp4";
    if(n.endsWith(".wav")) return "audio/wav";
    if(n.endsWith(".ogg")) return "audio/ogg";
    return "audio/mpeg";
  }

  function cardDoc(file){
    const url = `${CDN_BASE}/${encodeURI(file.name)}`;
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="title">üìÑ ${nice(file.name)}</div>
      <div class="meta">${file.name} ‚Ä¢ ${fmtSize(file.size)}</div>
      <a class="btn" href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</a>
      <div class="muted">–§–∞–π–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è /speeches/</div>
    `;
    return div;
  }

  function cardAudio(file){
    const url = `${CDN_BASE}/${encodeURI(file.name)}`;
    const type = extType(file.name);
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="title">üéß ${nice(file.name)}</div>
      <div class="meta">${file.name} ‚Ä¢ ${fmtSize(file.size)}</div>
      <audio controls preload="none" crossorigin="anonymous">
        <source src="${url}" type="${type}"/>
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
      </audio>
      <div class="note">–ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –∏–≥—Ä–∞–µ—Ç, –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É –Ω–∏–∂–µ.</div>
      <p><a class="btn" href="${url}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</a></p>
      <div class="muted">–§–∞–π–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è /audio/</div>
    `;
    return div;
  }

  // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ –∏–∑ jsDelivr DATA API
  function flattenFiles(tree, prefix=""){
    const out = [];
    (tree.files||[]).forEach(node=>{
      const path = prefix ? `${prefix}/${node.name}` : node.name;
      if(node.type === "file"){
        out.push({ name: path, size: node.size||null });
      } else if (node.type === "directory"){
        out.push(...flattenFiles(node, path));
      }
    });
    return out;
  }

  async function loadAllFiles(){
    const r = await fetch(DATA_API, {cache:"no-store"});
    if(!r.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ (jsDelivr)");
    const data = await r.json();
    return flattenFiles(data);
  }

  async function render(){
    const ws = document.getElementById('wrap-speech');
    const wa = document.getElementById('wrap-audio');
    ws.innerHTML = '<div class="card empty">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>';
    wa.innerHTML = '<div class="card empty">–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶</div>';

    try{
      const all = await loadAllFiles();

      const docs = all
        .filter(f => f.name.startsWith("speeches/") && endsWithAny(f.name, DOC_EXT))
        .sort((a,b)=>a.name.localeCompare(b.name,'ru',{numeric:true}));

      const auds = all
        .filter(f => f.name.startsWith("audio/") && endsWithAny(f.name, AUD_EXT))
        .sort((a,b)=>a.name.localeCompare(b.name,'ru',{numeric:true}));

      ws.innerHTML = ''; wa.innerHTML = '';
      if(!docs.length){
        ws.innerHTML = '<div class="card empty">–í ¬´/speeches¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å —Ç—É–¥–∞ —Ñ–∞–π–ª—ã –∏ —Å–¥–µ–ª–∞–π push ‚Äî –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è —Å–∞–º–∏.</div>';
      } else {
        docs.forEach(f => ws.appendChild(cardDoc(f)));
      }
      if(!auds.length){
        wa.innerHTML = '<div class="card empty">–í ¬´/audio¬ª –ø–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –∏ —Å–¥–µ–ª–∞–π push.</div>';
      } else {
        auds.forEach(f => wa.appendChild(cardAudio(f)));
      }
    }catch(e){
      ws.innerHTML = '<div class="card empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å jsDelivr.</div>';
      wa.innerHTML = '<div class="card empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å jsDelivr.</div>';
    }
  }

  function setupTabs(){
    const ts = document.getElementById('tab-speech');
    const ta = document.getElementById('tab-audio');
    const ws = document.getElementById('wrap-speech');
    const wa = document.getElementById('wrap-audio');
    ts.onclick = ()=>{ ts.classList.add('active'); ta.classList.remove('active'); ws.style.display='grid'; wa.style.display='none'; };
    ta.onclick = ()=>{ ta.classList.add('active'); ts.classList.remove('active'); wa.style.display='grid'; ws.style.display='none'; };
  }

  setupTabs();
  render();
</script>
</body>
</html>
